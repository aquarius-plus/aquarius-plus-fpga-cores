# Aquarius32 Technical Reference Manual

## Memory map

| Address       |    Width | Description                       |
| ------------- | -------: | --------------------------------- |
| 00000 - 007FF | 8/16/32b | Boot ROM (2kB)                    |
| 00800 - 01FFF |        - | -                                 |
| 02000         |      32b | ESP STATUS                        |
| 02004         |      32b | ESP DATA                          |
| 02008 - 0200C |      32b | -                                 |
| 02010         |      32b | KEYBUF                            |
| 02014         |      32b | HCTRL                             |
| 02018 / 0201C |  32b/32b | KEYS (64b)                        |
| 02020 / 02024 |  32b/32b | GAMEPAD1 (64b)                    |
| 02028 / 0202C |  32b/32b | GAMEPAD2 (64b)                    |
| 02030 - 0203C |      32b | -                                 |
| 02040         |      32b | VCTRL                             |
| 02044         |        - | -                                 |
| 02048         |      32b | VLINE                             |
| 0204C         |      32b | VIRQLINE                          |
| 02050         |      32b | VSCRX1                            |
| 02054         |      32b | VSCRY1                            |
| 02058         |      32b | VSCRX2                            |
| 0205C         |      32b | VSCRY2                            |
| 02060 - 0207C |        - | -                                 |
| 02080         |      32b | RISC-V mtime register             |
| 02084         |      32b | RISC-V mtimeh register            |
| 02088         |      32b | RISC-V mtimecmp register          |
| 0208C         |      32b | RISC-V mtimecmph register         |
| 02090 - 023FF |        - | -                                 |
| 02400 - 027FF |      32b | PCM playback                      |
| 02800 - 02FFF |      32b | FM synthesizer                    |
| 03000 - 033FF |      32b | Sprite attributes (256x32b)       |
| 03400 - 037FF |      32b | Sprite positions (256x32b)        |
| 03800 - 03FFF |        - | -                                 |
| 04000 - 040FF |      16b | Palette (8x16 entries)            |
| 04100 - 04FFF |        - | -                                 |
| 05000 - 057FF |       8b | Character RAM (2kB)               |
| 05800 - 05FFF |        - | -                                 |
| 06000 - 07FFF | 8/16/32b | Text RAM (8kB)                    |
| 08000 - 0FFFF | 8/16/32b | Video RAM (32kB)                  |
| 10000 - 1FFFF | 8/16/32b | Video RAM 4bpp addressable (64kB) |
| 20000 - 7FFFF |        - | -                                 |
| 80000 - FFFFF | 8/16/32b | RAM (512kB) (cached)              |

## CPU features

- RISC-V RV32IM core (hardware multiplier / divider)
- zicsr extension
- Only machine mode is available
- RAM is accessed via an 8KB direct mapped cache with single word cache lines

### Implemented CSRs

| Code  | Name     | Description                                                |
| ----- | -------- | ---------------------------------------------------------- |
| 0x300 | mstatus  | Machine status register                                    |
| 0x304 | mie      | Machine interrupt-enable register                          |
| 0x305 | mtvec    | Machine trap-handler base address                          |
| 0x340 | mscratch | Machine scratch register                                   |
| 0x341 | mepc     | Machine exception program counter                          |
| 0x342 | mcause   | Machine trap cause                                         |
| 0x343 | mtval    | Machine bad address or instruction                         |
| 0x344 | mip      | Machine interrupt pending                                  |
| 0xB00 | mcycle   | Machine cycle counter                                      |
| 0xB80 | mcycleh  | Upper 32 bits of mcycle                                    |
| 0xC00 | cycle    | Cycle counter (same as mcycle) (incrementing at 25.175MHz) |
| 0xC80 | cycleh   | Upper 32 bits of cycle (same as mcycleh)                   |
| 0xC01 | time     | Machine time counter (same as mtime at address 0x02080)    |
| 0xC81 | timeh    | Upper 32 bits of mtime (same as mtimeh at address 0x02084) |

## Interrupts

The interrupts can be controlled via the RISC-V MIE (Machine Interrupt Enable) and MIP (Machine Interrupt Pending) CSR registers.

| Interrupt number | Description                              |
| ---------------: | ---------------------------------------- |
|            0 - 6 | -                                        |
|                7 | Machine timer interrupt                  |
|           8 - 15 | -                                        |
|               16 | V-blank interrupt                        |
|               17 | Line interrupt                           |
|               18 | PCM FIFO threshold interrupt             |
|               19 | Keyboard buffer FIFO not empty interrupt |
|               20 | ESP UART RX FIFO not empty interrupt     |
|          21 - 31 | -                                        |

Interrupts 16 and 17 are latching, which means they have to cleared by clearing the bit in the MIP register. The other interrupts will be automatically cleared in the MIP register when the interrupt conditional no longer is present.

# ESP interface

This is used to communicate with the Aq+ ESP32. For example to perform file system access.

## ESP STATUS

| Bits | Name | Description                   |
| ---: | ---- | ----------------------------- |
| 31:2 | -    | -                             |
|    1 | TXF  | TX FIFO full (read-only)      |
|    0 | RXNE | RX FIFO not empty (read-only) |

## ESP DATA

| Bits | Name | Description                                                                              |
| ---: | ---- | ---------------------------------------------------------------------------------------- |
| 31:9 | -    | -                                                                                        |
|    8 | SOM  | Start of message. Writing a 1 to this bit will signal the start of a message to the ESP. |
|  7:0 | DATA | Data to transmit. (This field is ignored is SOM=1)                                       |

# Graphics engine

- Tile map size: 64x32
- 256 8x8 or 8x16 sprites
- Bitmap mode 320x200 @ 4bpp
- 8 16-color palettes for 128 colors on-screen out of 4096 possible colors

## VCTRL register

| Bits | Name     | Description                                                       |
| ---: | -------- | ----------------------------------------------------------------- |
| 31:7 | -        | -                                                                 |
|    6 | L2EN     | Enable tile layer 2 (only available when GFXMODE=1)               |
|    5 | SPREN    | Enable sprites                                                    |
|    4 | GFXMODE  | Graphics mode: 0:bitmap mode, 1:tile mode                         |
|    3 | GFXEN    | Enable graphics                                                   |
|    2 | TEXTPRIO | 0:Render text behind graphics, 1:Render text in front of graphics |
|    1 | TEXT80   | 0:40 columns mode, 1:80 columns mode                              |
|    0 | TEXTEN   | Enable text                                                       |


## VSCRX1/VSCRX2 register

This register controls the horizontal scrolling position in both tile (VSCRX1/VSCRX2) and bitmap modes (VSCRX1 only).

| Bits | Name | Description                        |
| ---: | ---- | ---------------------------------- |
| 31:9 | -    | -                                  |
|  8:0 | SCRX | Horizontal scroll position (0-511) |

## VSCRY1/VSCRY2 register

This register controls the vertical scrolling position in both tile (VSCRY1/VSCRY2) and bitmap modes (VSCRY1 only).

| Bits | Name | Description                      |
| ---: | ---- | -------------------------------- |
| 31:8 | -    | -                                |
|  7:0 | SCRY | Vertical scroll position (0-255) |

## VLINE register

| Bits | Name | Description                      |
| ---: | ---- | -------------------------------- |
| 31:8 | -    | -                                |
|  8:0 | LINE | Current line (read-only) (0-262) |

## VIRQLINE register

| Bits | Name | Description                                                                                         |
| ---: | ---- | --------------------------------------------------------------------------------------------------- |
| 31:8 | -    | -                                                                                                   |
|  8:0 | LINE | Line number to signal the line interrupt at. Interrupt is signalled at the last pixel of this line. |

# Keyboard interface

| Bits | Name | Description                      |
| ---: | ---- | -------------------------------- |
| 31:8 | -    | -                                |
|  7:0 | SCRY | Vertical scroll position (0-255) |

## KEYBUF register

The keyboard FIFO buffer has 15 entries of 16-bits each.

|  Bits | Name  | Description                      |
| ----: | ----- | -------------------------------- |
|    31 | EMPTY | Set when keyboard FIFO is empty. |
| 30:16 | -     | -                                |
|  15:0 | DATA  | Data from FIFO                   |

Data format (defined by ESP firmware):

| Bits | Description                 |
| ---: | --------------------------- |
|   15 | -                           |
|   14 | 1:Scancode / 0:Character    |
|   13 | Scancode key 0:up / 1:down  |
|   12 | 1:Repeated                  |
|   11 | Modifier key pressed: Gui   |
|   10 | Modifier key pressed: Alt   |
|    9 | Modifier key pressed: Shift |
|    8 | Modifier key pressed: Ctrl  |
|  7:0 | Character / Scancode        |

## Sprite attributes

|  Bits | Name   | Description                                                                                           |
| ----: | ------ | ----------------------------------------------------------------------------------------------------- |
| 31:18 | -      | -                                                                                                     |
| 17:16 | ZDEPTH | Z-depth to render at (0:sprite disabled,1:below bottom layer,2:between layer 1/2,3:on top of layer 2) |
| 15:13 | PAL    | Palette for this sprite (0-7)                                                                         |
|    12 | VFLIP  | Flip the sprite vertically                                                                            |
|    11 | HFLIP  | Flip the sprite horizontally                                                                          |
|    10 | H16    | Sprite height 0:8 pixels, 1:16 pixels                                                                 |
|   9:0 | IDX    | Tile index (0-1023)                                                                                   |

## Sprite positions

Sprites will wrap around edge of screen. For example setting the X position of the sprite to 511, will only show the rightmost 7 pixels of the sprite on the left side of the screen.

|  Bits | Name | Description                            |
| ----: | :--: | -------------------------------------- |
| 31:25 |  -   | -                                      |
| 24:16 |  Y   | Vertical position of sprite (0-255).   |
|  15:9 |  -   | -                                      |
|   8:0 |  X   | Horizontal position of sprite (0-511). |

# Video RAM data

| Address   | Description                        |
| --------- | ---------------------------------- |
| 0000-7FFF | Tile data (overlaps with tile map) |
| 0000-7CFF | Bitmap data                        |
| 6000-6FFF | Tile map layer 2 (z-depth=3)       |
| 7000-7FFF | Tile map layer 1 (z-depth=2)       |

## Tile map

64x32 entries, each with the following format:

|  Bits | Name  | Description                                                                |
| ----: | ----- | -------------------------------------------------------------------------- |
| 15:13 | PAL   | Palette for this tile (0-7)                                                |
|    12 | VFLIP | Flip the tile vertically                                                   |
|    11 | HFLIP | Flip the tile horizontally                                                 |
|    10 | PRIO  | Render the tile above sprites with the same z-depth (Layer1: 2, Layer2: 3) |
|   9:0 | IDX   | Tile index (0-1023)                                                        |

# PCM playback

The PCM playback unit allow playing back 16-bit stereo PCM samples. The samples are buffered in a FIFO buffer that holds up to 1023 samples. This allows for writing samples in bursts, for example at each V-Blank interval.

### Register 0 status register

This register reflects the number of samples currently in the FIFO buffer. The FIFO buffer can hold a maximum of 1023 16-bit stereo samples.

| 31:10 |      9:0       |
| :---: | :------------: |
|   -   | FIFO count (R) |

Writing to this register will reset the FIFO buffer and thus flush any samples still present.

### Register 1 FIFO control register

| 31:10 |           9:0           |
| :---: | :---------------------: |
|   -   | FIFO IRQ threshold (RW) |

As long as _FIFO count_ is lower than _FIFO IRQ threshold_, an interrupt is generated.
To clear the interrupt, first fill the FIFO buffer above the threshold and then clear the CPU interrupt.

### Register 2 Rate control register

This register is used to control the playback rate or sample rate.

| 31:12 | 11:0 |
| :---: | :--: |
|   -   | Rate |

The formulas to calculate the sample rate ($f_s$) in Hz from the **_Rate_** register value and vice versa:

$$f_s = \frac{Rate \times 25175000}{2^{20}} \qquad Rate = \frac{f_s \times 2^{20}}{25175000}$$

Some commonly used sample rates and their corresponding rate value:

| Desired sample rate | Closest rate | Actual sample rate |  Error |
| ------------------: | -----------: | -----------------: | -----: |
|             8000 Hz |          333 |            7994 Hz | 0.075% |
|            11025 Hz |          459 |           11020 Hz | 0.045% |
|            22050 Hz |          918 |           22040 Hz | 0.045% |
|            44100 Hz |         1837 |           44104 Hz | 0.009% |
|            48000 Hz |         1999 |           47993 Hz | 0.015% |

When starting playback, rate can be set to 0 at first, then the FIFO can be filled to a sufficient level and then RATE can be set to the actual playback rate. This helps prevent underruns on the first samples.

### Register 3 Sample data

This write-only register is used to write sample data into the FIFO buffer.
Sample data should be in signed 16-bit format.

|    31:16    |    15:0    |
| :---------: | :--------: |
| Right audio | Left audio |

# FM synthesizer

The FM synthesizer is based on the architecture of the OPL3 sound chip.
As such, OPL3 sound banks can be used on the Aq32 FM synthesizer.

Differences between the Aq32 FM synthesizer and OPL3 are:

| Aq32 FM synthesizer                                     | OPL3                                                |
| ------------------------------------------------------- | --------------------------------------------------- |
| 32 2-op channels configurable up to 16 4-op channels    | 18 2-op channels configurable up to 6 4-op channels |
| Panning control for each channel                        | Hard pan left/right/both                            |
| Not supported (Can be recreated using regular channels) | 3 channels can be converted into 5 rhythm sounds    |
| No timers (Use 60Hz V-Blank interrupt for timing)       | 2 Programmable timers                               |

### Register 0 OP_4CH

This register indicates what channel pairs are used as 4-channel operator.

|   Bit | Name     | Description                                     |
| ----: | -------- | ----------------------------------------------- |
| 31:16 | -        |                                                 |
|    15 | CH 31/30 | If set, channel 31/30 form a 4-operator channel |
|    14 | CH 29/28 | If set, channel 29/28 form a 4-operator channel |
|    13 | CH 27/26 | If set, channel 27/26 form a 4-operator channel |
|    12 | CH 25/24 | If set, channel 25/24 form a 4-operator channel |
|    11 | CH 23/22 | If set, channel 23/22 form a 4-operator channel |
|    10 | CH 21/20 | If set, channel 21/20 form a 4-operator channel |
|     9 | CH 19/18 | If set, channel 19/18 form a 4-operator channel |
|     8 | CH 17/16 | If set, channel 17/16 form a 4-operator channel |
|     7 | CH 15/14 | If set, channel 15/14 form a 4-operator channel |
|     6 | CH 13/12 | If set, channel 13/12 form a 4-operator channel |
|     5 | CH 11/10 | If set, channel 11/10 form a 4-operator channel |
|     4 | CH 9/8   | If set, channel 9/8 form a 4-operator channel   |
|     3 | CH 7/6   | If set, channel 7/6 form a 4-operator channel   |
|     2 | CH 5/4   | If set, channel 5/4 form a 4-operator channel   |
|     1 | CH 3/2   | If set, channel 3/2 form a 4-operator channel   |
|     0 | CH 1/0   | If set, channel 1/0 form a 4-operator channel   |

### Register 1 GLOBAL

|  Bit | Name | Description                |
| ---: | ---- | -------------------------- |
| 31:8 | -    | -                          |
|    7 | DAM  | Amplitude modulation depth |
|    6 | DVB  | Vibrato depth              |
|  5:0 | -    | -                          |

### Register 2 KEY_ON

Each bit in this register controls the Key-on signal of each channel

| Bit | Name    | Description       |
| --: | ------- | ----------------- |
|  31 | KEYON31 | Key-on channel 31 |
|  30 | KEYON30 | Key-on channel 30 |
|  29 | KEYON29 | Key-on channel 29 |
|  28 | KEYON28 | Key-on channel 28 |
|  27 | KEYON27 | Key-on channel 27 |
|  26 | KEYON26 | Key-on channel 26 |
|  25 | KEYON25 | Key-on channel 25 |
|  24 | KEYON24 | Key-on channel 24 |
|  23 | KEYON23 | Key-on channel 23 |
|  22 | KEYON22 | Key-on channel 22 |
|  21 | KEYON21 | Key-on channel 21 |
|  20 | KEYON20 | Key-on channel 20 |
|  19 | KEYON19 | Key-on channel 19 |
|  18 | KEYON18 | Key-on channel 18 |
|  17 | KEYON17 | Key-on channel 17 |
|  16 | KEYON16 | Key-on channel 16 |
|  15 | KEYON15 | Key-on channel 15 |
|  14 | KEYON14 | Key-on channel 14 |
|  13 | KEYON13 | Key-on channel 13 |
|  12 | KEYON12 | Key-on channel 12 |
|  11 | KEYON11 | Key-on channel 11 |
|  10 | KEYON10 | Key-on channel 10 |
|   9 | KEYON9  | Key-on channel 9  |
|   8 | KEYON8  | Key-on channel 8  |
|   7 | KEYON7  | Key-on channel 7  |
|   6 | KEYON6  | Key-on channel 6  |
|   5 | KEYON5  | Key-on channel 5  |
|   4 | KEYON4  | Key-on channel 4  |
|   3 | KEYON3  | Key-on channel 3  |
|   2 | KEYON2  | Key-on channel 2  |
|   1 | KEYON1  | Key-on channel 1  |
|   0 | KEYON0  | Key-on channel 0  |

### Registers 96-127 Channel attributes

|  Bits | Name  | Description                                    |
| ----: | ----- | ---------------------------------------------- |
| 31:27 | -     | -                                              |
| 26:20 | PAN   | 0:No Audio, 1:Left, 64:Center, 127:Right       |
| 19:17 | FB    | Modulation depth for slot 1 FM feed back (0-7) |
|    16 | ALG   | Operation connection (algorithm)               |
| 15:13 | -     | -                                              |
| 12:10 | BLOCK | Octave (0-7)                                   |
|   9:0 | FNUM  | Frequency number (10 bit)                      |

### Registers 128-191 Operator attributes 0

|  Bits | Name | Description                                   |
| ----: | ---- | --------------------------------------------- |
|    31 | AM   | Amplitude modulation (Tremelo)                |
|    30 | VIB  | Vibrato                                       |
|    29 | SUS  | 0:Skip sustain phase, 1:Sustain until key off |
|    28 | KSR  | Key scale rate                                |
| 27:24 | MULT | Frequency data multiplier (0-15)              |
| 23:22 | KSL  | Key scale level (0-3)                         |
| 21:16 | TL   | Total level (0-63)                            |
| 15:12 | AR   | Attack Rate (0-15)                            |
|  11:8 | DR   | Decay Rate (0-15)                             |
|   7:4 | SL   | Sustain Level (0-15)                          |
|   3:0 | RR   | Release Rate (0-15)                           |

### Registers 192-255 Operator attributes 1

| Bits | Name | Description       |
| ---: | ---- | ----------------- |
| 31:3 | -    | -                 |
|  2:0 | WS   | Wave select (0-7) |
