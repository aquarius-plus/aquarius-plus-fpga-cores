# Aquarius32 TRM

## Memory map

| Address       |    Width | Description                  |
| ------------- | -------: | ---------------------------- |
| 00000 - 007FF | 8/16/32b | Boot ROM (2kB)               |
| 00800 - 01FFF |        - | -                            |
| 02000         |      32b | ESP CTRL                     |
| 02004         |      32b | ESP DATA                     |
| 02008         |      32b | VCTRL                        |
| 0200C         |      32b | VSCRX                        |
| 02010         |      32b | VSCRY                        |
| 02014         |      32b | VLINE                        |
| 02018         |      32b | VIRQLINE                     |
| 0201C         |      32b | KEYBUF                       |
| 02020 - 0207C |        - | -                            |
| 02080         |      32b | RISC-V mtime register        |
| 02084         |      32b | RISC-V mtimeh register       |
| 02088         |      32b | RISC-V mtimecmp register     |
| 0208C         |      32b | RISC-V mtimecmph register    |
| 02090 - 023FF |        - | -                            |
| 02400 - 027FF |      32b | PCM playback                 |
| 02800 - 02FFF |      32b | FM synthesizer               |
| 03000 - 031FF |      32b | Sprite attributes (64x2x32b) |
| 03200 - 03FFF |        - | -                            |
| 04000 - 0407F |      16b | Palette (4x16 entries)       |
| 04080 - 04FFF |        - | -                            |
| 05000 - 057FF |       8b | Character RAM (2kB)          |
| 05800 - 05FFF |        - | -                            |
| 06000 - 06FFF |    8/16b | Text RAM (4kB)               |
| 07000 - 07FFF |        - | -                            |
| 08000 - 0FFFF | 8/16/32b | VRAM (32kB)                  |
| 10000 - 1FFFF | 8/16/32b | VRAM 4bpp addressable (64kB) |
| 20000 - 7FFFF |        - | -                            |
| 80000 - FFFFF | 8/16/32b | RAM (512kB) (cached)         |

## CPU features

- RISC-V RV32IM core (hardware multiplier / divider)
- zicsr extension
- Only machine mode is available

### Implemented CSRs

| Code  | Name     | Description                                                |
| ----- | -------- | ---------------------------------------------------------- |
| 0x300 | mstatus  | Machine status register                                    |
| 0x304 | mie      | Machine interrupt-enable register                          |
| 0x305 | mtvec    | Machine trap-handler base address                          |
| 0x340 | mscratch | Machine scratch register                                   |
| 0x341 | mepc     | Machine exception program counter                          |
| 0x342 | mcause   | Machine trap cause                                         |
| 0x343 | mtval    | Machine bad address or instruction                         |
| 0x344 | mip      | Machine interrupt pending                                  |
| 0xB00 | mcycle   | Machine cycle counter                                      |
| 0xB80 | mcycleh  | Upper 32 bits of mcycle                                    |
| 0xC00 | cycle    | Cycle counter (same as cycle) (incrementing at 25.175MHz)  |
| 0xC80 | cycleh   | Upper 32 bits of cycle (same as cycleh)                    |
| 0xC01 | time     | Machine time counter (same as mtime at address 0x02080)    |
| 0xC81 | timeh    | Upper 32 bits of mtime (same as mtimeh at address 0x02084) |

## Interrupts

The interrupts can be controlled via the RISC-V MIE (Machine Interrupt Enable) and MIP (Machine Interrupt Pending) CSR registers.

| Interrupt number | Description                          |
| ---------------: | ------------------------------------ |
|            0 - 6 | -                                    |
|                7 | Machine timer interrupt              |
|           8 - 15 | -                                    |
|               16 | V-blank interrupt                    |
|               17 | Line interrupt                       |
|               18 | PCM FIFO threshold interrupt         |
|               19 | Keybuf FIFO not empty interrupt      |
|               20 | ESP UART RX FIFO not empty interrupt |
|          21 - 31 | -                                    |

Interrupts 16 and 17 are latching, which means they have to cleared by clearing the bit in the MIP register. The other interrupts will be automatically cleared in the MIP register when the interrupt conditional no longer is present.

## ESP CTRL

| 31:5 |            4            |            3            |  2  |      1      |        0         |
| :--: | :---------------------: | :---------------------: | :-: | :---------: | :--------------: |
|  -   | RX FIFO overflow (R/WC) | RX framing error (R/WC) |  -  | TX full (R) | RX not empty (R) |

## ESP DATA

| 31:9 |        8         | 7:0  |
| :--: | :--------------: | :--: |
|  -   | Start of message | Data |

## VCTRL

| 31:6 |   5    |            4             |   3    |       2       |       1        |    0    |
| :--: | :----: | :----------------------: | :----: | :-----------: | :------------: | :-----: |
|  -   | Spr_en | Gfx_mode: bm(0), tile(1) | Gfx_en | Text_priority | Text_80columns | Text_en |

## Sprite attributes

Even addresses:

| 31:25 | 24:16 | 15:8 | 7:0 |
| :---: | :---: | :--: | :-: |
|   -   |   Y   |  -   |  X  |

Odd addresses:

| 31:16 |    15    |  14:13  |   12   |   11   |    10     |       9:0        |
| :---: | :------: | :-----: | :----: | :----: | :-------: | :--------------: |
|   -   | Priority | Palette | V-flip | H-flip | Height:16 | Tile index (9:0) |

# Video RAM data

| Address   | Description                        |
| --------- | ---------------------------------- |
| 0000-7FFF | Tile data (overlaps with tile map) |
| 0000-7CFF | Bitmap data                        |
| 7000-7FFF | Tile map                           |

## Tile map

64x32 entries, each with the following format:

|    15    |  14:13  |   12   |   11   | 10  |       9:0        |
| :------: | :-----: | :----: | :----: | :-: | :--------------: |
| Priority | Palette | V-flip | H-flip |  -  | Tile index (9:0) |

# PCM playback

### Register 0 status register

This register reflects the number of samples currently in the FIFO buffer. The FIFO buffer can hold a maximum of 1023 16-bit stereo samples.

| 31:10 |      9:0       |
| :---: | :------------: |
|   -   | FIFO count (R) |

Writing to this register will reset the FIFO buffer and thus flush any samples still present.

### Register 1 FIFO control register

| 31:10 |          9:0           |
| :---: | :--------------------: |
|   -   | FIFO IRQ treshold (RW) |

As long as _FIFO count_ is lower than _FIFO IRQ treshold_, an interrupt is generated.
To clear the interrupt, first fill the FIFO buffer above the threshold and then clear the CPU interrupt.

### Register 2 Rate control register

This register is used to control the playback rate or sample rate.

| 31:12 | 11:0 |
| :---: | :--: |
|   -   | Rate |

The formulas to calculate the sample rate ($f_s$) in Hz from the **_Rate_** register value and vice versa:

$$f_s = \frac{Rate \times 25175000}{2^{20}} \qquad Rate = \frac{f_s \times 2^{20}}{25175000}$$

Some commonly used sample rates and their corresponding rate value:

| Desired sample rate | Closest rate | Actual sample rate |  Error |
| ------------------: | -----------: | -----------------: | -----: |
|             8000 Hz |          333 |            7994 Hz | 0.075% |
|            11025 Hz |          459 |           11020 Hz | 0.045% |
|            22050 Hz |          918 |           22040 Hz | 0.045% |
|            44100 Hz |         1837 |           44104 Hz | 0.009% |
|            48000 Hz |         1999 |           47993 Hz | 0.015% |

When starting playback, rate can be set to 0 at first, then the FIFO can be filled to a sufficient level and then RATE can be set to the actual playback rate. This helps prevent underruns on the first samples.

### Register 3 Sample data

This write-only register is used to write sample data into the FIFO buffer.
Sample data should be in signed 16-bit format.

|    31:16    |    15:0    |
| :---------: | :--------: |
| Right audio | Left audio |

# FM synthesizer

### Register 0

This register indicates what channel pairs are used as 4-channel operator.

| 31:16 |    15    |    14    |    13    |    12    |    11    |    10    |    9     |    8     |    7     |    6     |    5     |   4    |   3    |   2    |   1    |   0    |
| :---: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :------: | :----: | :----: | :----: | :----: | :----: |
|   -   | CH 31/30 | CH 29/28 | CH 27/26 | CH 25/24 | CH 23/22 | CH 21/20 | CH 19/18 | CH 17/16 | CH 15/14 | CH 13/12 | CH 11/10 | CH 9/8 | CH 7/6 | CH 5/4 | CH 3/2 | CH 1/0 |

### Register 1

| 31:8 |  7  |  6  | 5:0 |
| :--: | :-: | :-: | :-: |
|  -   | DAM | DVB |  -  |

| Name | Description                |
| ---- | -------------------------- |
| DAM  | Amplitude modulation depth |
| DVB  | Vibrato depth              |

### Register 2

Each bit in this register controls the Key-on signal of each channel

### Registers 96-127 Channel attributes

| 31:27 | 26:20 | 19:17 | 16  | 15:13 | 12:10 | 9:0  |
| :---: | :---: | :---: | :-: | :---: | :---: | :--: |
|   -   |  PAN  |  FB   | ALG |   -   | BLOCK | FNUM |

| Name  | Description                                    |
| ----- | ---------------------------------------------- |
| PAN   | 0:No Audio, 1:Left, 64:Center, 127:Right       |
| FB    | Modulation depth for slot 1 FM feed back (0-7) |
| ALG   | Operation connection (algorithm)               |
| KON   | Key on                                         |
| BLOCK | Octave (0-7)                                   |
| FNUM  | Frequency number (10 bit)                      |

### Registers 128-191 Operator attributes 0

| 31  | 30  | 29  | 28  | 27:24 | 23:22 | 21:16 | 15:12 | 11:8 | 7:4 | 3:0 |
| :-: | :-: | :-: | :-: | :---: | :---: | :---: | :---: | :--: | :-: | --- |
| AM  | VIB | SUS | KSR | MULT  |  KSL  |  TL   |  AR   |  DR  | SL  | RR  |

| Name | Description                                   |
| ---- | --------------------------------------------- |
| AM   | Amplitude modulation (Tremelo)                |
| VIB  | Vibrato                                       |
| SUS  | 0:Skip sustain phase, 1:Sustain until key off |
| KSR  | Key scale rate                                |
| MULT | Frequency data multiplier (0-15)              |
| KSL  | Key scale level (0-3)                         |
| TL   | Total level (0-63)                            |
| AR   | Attack Rate (0-15)                            |
| DR   | Decay Rate (0-15)                             |
| SL   | Sustain Level (0-15)                          |
| RR   | Release Rate (0-15)                           |

### Registers 192-255 Operator attributes 1

| 31:3 | 2:0 |
| :--: | --- |
|  -   | WS  |

| Name | Description       |
| ---- | ----------------- |
| WS   | Wave select (0-7) |

## CPU

RISC-V
RAM cache
